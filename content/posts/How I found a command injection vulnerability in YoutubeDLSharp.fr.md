---
title: "Comment J'ai D√©couvert une Vuln√©rabilit√© D'injection de Commande dans YoutubeDLSharp"
date: '2025-06-13T14:39:16-04:00'
tags: ["cve","c#"]
comments: true
description: "Un ¬´ heureux ¬ª accident connu sous le nom de GHSA-2jh5-g5ch-43q5, alias CVE-2025-43858."
searchHidden: false
---
Voici l'histoire de mon premier rapport de vuln√©rabilit√©. C'√©tait un peu une d√©couverte ¬´ accidentelle ¬ª, mais apr√®s r√©flexion, je pense que √ßa vaut quand m√™me la peine d'en parler.  
Avant d'aller droit au but, un peu de contexte.
## Contexte
J'ai commenc√© √† √©crire mon propre projet C# ([OngakuVault](https://github.com/kitsumed/OngakuVault)) pour automatiser l'archivage de fichiers audio vers mon stockage distant. J'en avais assez de devoir me connecter en SFTP/SSH et de r√©activer toutes les s√©curit√©s √† chaque d√©connexion. C'est comme √ßa que j'ai commenc√© mon application API ASP.NET, con√ßue pour √™tre accessible via le web. Pour r√©cup√©rer les contenus m√©dia, j'ai choisi d'utiliser [yt-dlp](https://github.com/yt-dlp/yt-dlp) car c'est un peu un couteau suisse : il supporte plein de sites et formats (appel√©s ¬´ extracteurs ¬ª), ainsi que des URLs directes.  
Je ne voulais pas √©crire mon propre wrapper (perte de temps, et je ne savais vraiment par o√π commencer) pour communiquer avec l'√©x√©cutable externe. J'ai donc cherch√© une library  open-source, et parmi tous les r√©sultats, [YoutubeDLSharp](https://github.com/Bluegrams/YoutubeDLSharp) √©tait la meilleure que j'ai trouv√©e.

## Le d√©but
J'ai toujours eu un certain int√©r√™t pour la s√©curit√© en informatique, sans √™tre un expert, mais j'ai regard√© quelques YouTubers comme [Low Level](https://www.youtube.com/@LowLevelTV) et lu [des blogs](https://mksben.l0.cm/2020/10/discord-desktop-rce.html) sur des d√©couvertes de vuln√©rabilit√©s. C'est pourquoi, quand j'ai d√©cid√© d'utiliser **YoutubeDLSharp**, j'ai fait quelque chose que beaucoup de d√©veloppeurs dise en blaque : J'ai lu tout le code source. Je n'ai pas forc√©ment tout compris ni pass√© tout mon temps √† le d√©cortiquer, ce n'√©tait pas le but. Je voulais juste m'assurer qu'il n'y avait rien de malveillant.

*Ai-je trouv√© quelque chose de malveillant* ? **Non**. Mais une partie du code me donnais un sentiment √©trange. J'ai eu un dr√¥le de pressentiment, et c'est justement cette partie qui allait plus tard devenir **[CVE-2025-43858](https://www.cve.org/CVERecord?id=CVE-2025-43858)**. Mais √† ce moment-l√†, je n'y ai pas trop pr√™t√© attention. Apr√®s plus d'une heure de lecture, j'√©tais fatigu√© et **il n'y avait aucune mention ni recommandation de faire de la v√©rification des inputs nous-m√™mes dans le README**. La biblioth√®que √©tant justement un wrapper fait pour communiqu√©e avec yt-dlp, je me suis dit "***Ils doivent s√ªrement g√©rer √ßa de mani√®re s√ªre***".  
**Spoiler**: *Non :)*.

## Quelques mois plus tard - La d√©couverte  
Quelques mois plus tard, pendant que je travaillait sur mon projet, en debugant les interactions avec le wrapper YoutubeDLSharp, j'ai vu gr√¢ce √† [Sysinternals Process Explorer](https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer) sur mon second √©cran que **yt-dlp √©tait lanc√© par une invite de commande**. (*Je suis s√ªr que certains comprennent d√©j√† ou je m'en vais avec √ßa*). La simple vue du processus `cmd` m'a rappel√© ce dr√¥le de sentiment que j'avais eu en lisant le code.

√Ä ce moment pr√©cis, sans trop savoir pourquoi, j'ai arr√™t√© de d√©boguer et j'ai eu envie d'envoyer b√™tement des requ√™tes GET √† mon application avec des URLs forg√©es. Ces URLs √©taient trait√©es par mon application puis donn√©es au wrapper YoutubeDLSharp qui lan√ßait l'√©x√©cutable yt-dlp. Apr√®s environ 8 minutes √† essayer diff√©rentes URLs, j'ai √©crit `https://example.com/" & start calc.exe` et appuy√© sur Entr√©e une derni√®re fois. **Mon application a plant√©**. En regardant les logs du d√©bogueur Visual Studio, je me suis demand√© : "*Est-ce que je g√®re mal les exceptions d'URL ?*", mais cette pens√©e a vite √©t√© remplac√©e par : "**Attends, pourquoi calc.exe est ouvert dans ma barre des t√¢ches ?**".

**Je venais de faire une injection de commande**.

Pour √™tre honn√™te, je ne me souviens plus de l'exception exacte de mon application, et je n'ai jamais r√©ussi √† la reproduire. Je ne comprenais pas pourquoi elle plantait compl√®tement alors que tout √©tait dans un `try-catch`. **Ce que j'ai pu reproduire, en revanche, c'est la cr√©ation d'URLs forg√©es ¬´ malicieuses ¬ª pour injecter des commandes dans le cmd**. Quand j'en ai pris conscience, j'√©tais surtout content. Je me suis amus√© localement √† enregistrer quelques PoCs marrants qui ouvraient des vid√©os "memes".

Mais j'√©tais aussi tr√®s emb√™t√©. Mon application, cens√©e **√™tre accessible √† distance via une interface web et une API**, pouvait √™tre compl√®tement compromise avec une simple requ√™te GET. Je savais que c'√©tait grave, **tr√®s grave**.

### PoC
```c#
using YoutubeDLSharp;

public async Task<RunResult<VideoData>> GetMediaInformation()
{
        YoutubeDL youtubeDl = new YoutubeDL();
	// Fetch media information using a badly crafted "url" (escaped)
	return await youtubeDl.RunVideoDataFetch("https://example.com/\" & start calc.exe");
}
```
Voici une capture d'√©cran d'un exemple o√π `calc.exe` a √©t√© remplac√© par `msinfo32`.
![showcase](https://github.com/user-attachments/assets/d6f5513c-a69b-4cdd-9820-3f4d71b5c457)

## Emp√™cher l'exploitation
Une de mes premi√®res id√©es fut de reporter le probl√®me au propri√©taire (**[alxnull](https://github.com/alxnull)**). Mais le d√©p√¥t GitHub de **YoutubeDLSharp** √©tait peu actif et le propri√©taire peu pr√©sent. J'ai donc d'abord fait un fix pour mon propre usage. J'ai identifi√© les deux caract√®res qui permettaient l'exploitation de la vuln√©rabilit√© : `"` et `&`.

- Le caract√®re `"` dans l'invite de commande sert √† d√©limiter du texte : `"Mon Texte"`.  
- Le caract√®re `&` sert √† ex√©cuter plusieurs commandes en une seule instruction : `echo Salut & echo √áa va !` lancerait les deux commandes l'une apr√®s l'autre.

Je me suis alors demand√© s'il √©tait possible de remplacer ces deux caract√®res dans les URLs, **SANS casser l'URL** (sans la rendre invalide).  
**Oui, c'est possible** gr√¢ce √† **l'encodage URL**, aussi appel√© **[percent-encoding](https://en.wikipedia.org/wiki/Percent-encoding)**. L'encodage URL transforme une liste sp√©cifique de caract√®res, incluant `"` et `&`, en valeurs `%??`.

J'ai cherch√© les m√©thodes existantes d'encodage URL en C# et j'ai d√©cid√© que la meilleure fa√ßon √©tait de convertir ma cha√Æne d'URL en un type [Uri](https://learn.microsoft.com/en-us/dotnet/api/system.uri?view=net-8.0) qui a une propri√©t√© encod√©e avec le percent-encoding.

**Le fix √©tait n√©** :
```c#
public static string? SanitizeUrl(string url)
{
	// Parse the URL using Uri
	if (Uri.TryCreate(url, UriKind.Absolute, out Uri? urlUri))
	{
		// According to the microsoft docs getting the absolute url append
		// all of the others fields, theses fields get URI escaped when you GET them
		// (https://learn.microsoft.com/en-us/dotnet/api/system.uri.query?view=net-8.0#remarks) 
		return urlUri.AbsoluteUri;
	}
	// Invalid url format
	return null;
}
```
Avec cette m√©thode, l'URL forg√©e `https://example.com/" & start calc.exe` devient `https://example.com/%22%20&%20start%20calc.exe`, ce qui emp√™che l'exploitation de la vuln√©rabilit√©.

M√™me si ce code r√®gle le probl√®me des URLs forg√©es dans mon application, il faut noter que th√©oriquement (je ne l'ai pas test√©), les options pass√©es en arguments aux commandes *(exemple : `-myArg "patate"`)* lors de l'appel √† yt-dlp pourraient aussi √™tre exploit√©es, **et l'encodage URL ne vous prot√©gerait pas contre √ßa**.

**Et m√™me si √ßa fonctionnait, √ßa causerait probablement plus de probl√®mes**. C'est pourquoi, en r√©digeant le rapport de vuln√©rabilit√©, j'ai jet√© un coup d'oeil rapide au code source et trouv√© un moyen de mitiger compl√®tement le probl√®me au prix d'une perte de fonctionnalit√© (fonctionnalit√© que **alxnull** m'a dit plus tard ne pas √™tre vraiment n√©cessaire).

Je ne rentrerai pas dans les d√©tails, mais la mitigation compl√®te √©tait assez simple. Le seul inconv√©nient √©tait de ne plus pouvoir utiliser de m√©thodes ¬´ user-friendly ¬ª et de devoir g√©rer le wrapper √† un niveau plus ¬´ bas ¬ª :
```c#
YoutubeDLProcess youtubeDLProc = new YoutubeDLProcess()
{
    // That's the important part!!! No more funny cmd starting yt-dlp
    UseWindowsEncodingWorkaround = false 
};
```

## Signaler la vuln√©rabilit√©  
Signaler la vuln√©rabilit√© fut un d√©fi en soi. J'avais lu sur la [fonctionnalit√© GitHub Advisories](https://docs.github.com/en/code-security/security-advisories/guidance-on-reporting-and-writing-information-about-vulnerabilities/privately-reporting-a-security-vulnerability) mais elle √©tait d√©sactiv√©e sur son d√©p√¥t. J'√©tais m√©langer sur la marche √† suivre et ne trouvais pas comment le contacter. J'ai fini par trouver un email dans l'une de ses organisations et l'ai utilis√© pour lui demander d'activer la fonction GitHub Advisories. Ce mail contenait les instructions pour me r√©pondre. Je n'ai jamais eu de r√©ponse, mais environ 3 √† 4 semaines apr√®s l'envoi, j'ai constat√© que la fonctionnalit√© √©tait activ√©e. Est-ce que j'es manqu√©e un courriel r√©ponse ou est-ce qu'il ne ma jamais r√©pondu ? Je n'en sais rien.

J'ai poursuivi en cr√©ant le rapport advisory et [localis√© les lignes exactes dans le commit](https://github.com/Bluegrams/YoutubeDLSharp/commit/fdf3256da18d0e2da4a2f33ad4a1b72ff8273a50#diff-8ec44b4ade6ce6ed38ebf7e765dc86c426984a18304cd1cd320bf92500133c88R107) qui introduisaient le bug. Je me souviens aussi avoir √©t√© un peu perdu en faisant le score CVSS. Au d√©but, j'essayais de faire un CVSS v4, mais certaines cat√©gories √©taient trop compliqu√©es, et la v3 en avait moins, donc j'ai pris celle-l√† üëç.

La vuln√©rabilit√© a fini class√©e **9.2 critique**, la biblioth√®que n'√©tant pas tr√®s populaire, donc je doute que cette d√©couverte ait eu un impact ¬´ global ¬ª important.  
J'ai ensuite d√©couvert les **CWE** (***Common Weakness Enumerator***). D'apr√®s ce que j'ai compris, ce sont des listes d'erreurs courantes menant √† des vuln√©rabilit√©s. On peut les r√©f√©rencer dans un rapport, donc j'ai r√©f√©renc√© :
- `CWE-77` (***Neutralisation incorrecte d'√©l√©ments sp√©ciaux utilis√©s dans une commande***)  
- `CWE-78` (***Neutralisation incorrecte d'√©l√©ments sp√©ciaux utilis√©s dans une commande syst√®me***)  
- `CWE-20` (***Validation incorrecte des entr√©es***).

Apr√®s r√©flexion, je ne pense pas que `CWE-20` s'applique ici (il n'y avais pas de validation). Il semble aussi qu'elle soit manquante dans le [record CVE](https://www.cve.org/CVERecord?id=CVE-2025-43858).

Une fois mon rapport termin√©, j'ai attendu. Comme je n'√©tais pas s√ªr que le propri√©taire soit encore actif, j'ai mentionn√© dans les commentaires le **2025-02-23** que j'attendrais environ 3 semaines un signe de vie, et si je n'en avais pas, je publierais une copie du rapport publiquement.

J'ai fait √ßa car mon propre projet avait d√©j√† un commit avec le fix, et publier mon projet rendrait la vuln√©rabilit√© ¬´ publique ¬ª, donc je l'ai gard√©e priv√©e. Cependant, apr√®s 3 semaines, j'ai trouv√© que c'√©tait trop court et j'ai d√©cid√© d'attendre encore. Le **2025-03-26**, j'en ai eu assez et j'ai d√©cid√© de [la rendre publique via une issue](https://github.com/Bluegrams/YoutubeDLSharp/issues/68). J'ai aussi mis √† jour le rapport advisory priv√© pour avertir l'owner du d√©p√¥t.

Le **2025-04-22**, j'ai eu le premier signe de vie du propri√©taire, **alxnull**. Le [rapport advisory a √©t√© accept√©](https://github.com/Bluegrams/YoutubeDLSharp/issues/68#issuecomment-2822152155). Peu apr√®s, un commit a √©t√© fait, corrigeant le probl√®me en supprimant compl√®tement **UseWindowsEncodingWorkaround** dans la version ``v1.1.2``. L'advisory a ensuite √©t√© publi√© sur GitHub le **2025-04-23** sous le nom **GHSA-2jh5-g5ch-43q5**, et le **2025-04-24** elle a √©t√© accept√© dans la base de donn√©e CVE sous le nom **CVE-2025-43858**.

Voil√† qui conclut mon histoire. Si vous voulez lire le rapport CVE complet, avec un peu plus de d√©tails sur le code qui causait la vuln√©rabilit√©, vous pouvez le trouver [ici](https://github.com/advisories/GHSA-2jh5-g5ch-43q5). N'h√©sitez pas √† laisser un commentaire si vous avez des recommandations, par exemple sur la fa√ßon dont j'aurais d√ª g√©rer la publication du rapport apr√®s les 3+ semaines.